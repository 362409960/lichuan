jQuery.extend(jQuery.expr[":"],{focus:function(a){return a===document.activeElement}});var payload,android_permiss=null,ios_permiss=null,parent_id=null,_location=(window.location.pathname.split("/")[1]==path.substr(1))?window.location.pathname.split("/").slice(1):window.location.pathname.split("/"),feature=_location[1],appKey=_location[2],mod=_location[3],sendType=_location[4],pushType=_location[5],is_richpush=(pushType!=null&&pushType!=""),is_richpush_pay=false,richpush_limit=false;define(function(require){var tz_offset_mapping=require("public/modules/timezone"),i18n=require("public/utils/i18n");if(typeof _APP!=="undefined"){is_richpush_pay=_APP.rich_push_pay>0;richpush_limit=_APP.richpush_limit=="true"}var pushManager=(function(){var recipientTypes={broadcast:$("#id_recipient_type_0"),tags:$("#id_recipient_type_1"),alias:$("#id_recipient_type_2"),imei:$("#id_recipient_type_3"),registrationid:$("#id_recipient_type_4"),segmentid:$("#id_recipient_type_5")};var deliveryTypes={now:$("#id_delivery_type_0"),scheduled:$("#id_delivery_type_1"),duration:$("#id_delivery_type_2")};var deliveryFields={duration_time:$("#id_duration_time")};$.each(["date","time","timezone"],function(i,item){deliveryFields[item]=$("#id_delivery_"+item)});var deviceTypes;var richMediaType={rich_media_net:$("#id_rich_media_type_0"),rich_media_net_file:$("#id_rich_media_type_0_file"),rich_media_local:$("#id_rich_media_type_1"),rich_media_local_file:$("#id_rich_media_type_1_file"),};if(pushType==="richpush"||pushType==="richmediapush"){$("#id_rich_push_state").val("true")}function checkPushType(){if(pushType==="richpush"){return true}return false}var submitButton=$("#submitButton");var padNum=function(num){if(num<10){num="0"+num}return num.toString()};var fieldMap={inherit:{alert:"alert",imei:"imei",alias:"alias",tags:"tags"},aps:{options:{badge:function(val){return val},sound:function(val){return val}}},android:{options:{}},aps_product:{options:{badge:function(val){return val},sound:function(val){return val}}},wp:{options:{open_page:function(val){return val}}},};var generatePayload=function(){var payload={};payload.platform=[];$.each(deviceTypes,function(i,item){if($(".class_"+item).is(":checked")){for(var k in fieldMap[item].options){var field=$("#id_"+k.replace(/\-/g,"_"));if(field.val()){payload[k]=fieldMap[item].options[k].call(this,field.val())}}payload.platform.push(item)}});var alert=$("#id_alert"),alert_title=$("#id_alert_title"),time_to_live=$("#id_time_to_live"),notification_bar=$("#id_android_notification_bar_id"),imei=$("#id_imei"),registrationid=$("#id_registrationid"),segmentid=$("#id_segmentid"),alias=$("#id_alias");open_page=$("#id_open_page");if(alert.length>0&&alert.val()&&(!$("#id_silent_push").is(":checked"))){payload[fieldMap.inherit.alert]=alert.val()}if(imei.length>0&&imei.val()){payload[fieldMap.inherit.imei]=imei.val()}if(registrationid.length>0&&registrationid.val()){payload[fieldMap.inherit.registrationid]=registrationid.val()}if(segmentid.length>0&&segmentid.val()){payload[fieldMap.inherit.segmentid]=segmentid.val()}if(alias.length>0&&alias.val()){payload[fieldMap.inherit.alias]=alias.val()}if(recipientTypes.tags.is(":checked")){var out=[];for(var k in tags.selectedTags){out.push(k)}if(out.length){payload[fieldMap.inherit.tags]=out;$("#id_tags").val(out.join(","))}}if(deliveryTypes.scheduled.is(":checked")){$("#later-duration").hide();var d=delivery.parseDate();if(delivery.validDate(d)){submitButton.html(i18n.scheduledpush);$("#timezone-note").show();$("#later-delivery").show()}}else{if(deliveryTypes.duration.is(":checked")){submitButton.html(i18n.durationpush);$("#timezone-note").hide();$("#later-delivery").hide();$("#later-duration").show()}else{submitButton.html(i18n.sendnow);$("#later-duration").hide();$("#timezone-note").hide();$("#later-delivery").hide()}}var max_time_to_live=864000;if(time_to_live.length>0){var ttl=time_to_live.val();time_to_live>max_time_to_live?max_time_to_live:ttl;payload.time_to_live=ttl;time_to_live.val(ttl)}if($("#id_android").is(":checked")){if(notification_bar.length>0&&$.trim(notification_bar.val())!=""){payload.builder_id=notification_bar.val()}if(alert_title.length>0&&$.trim(alert_title.val())!=""){payload.title=alert_title.val()}}var custom_keys=[];$(".custom_key").each(function(index){key_number=$(this).attr("id").replace("id_key","");var key=$(this).val().trim();if(key!==""){var value=$("#id_value"+key_number).val();custom_keys.push([key,value]);payload.extra=payload.extra||{};payload.extra[key]=value}});if(custom_keys.length>0){$("#id_custom_keys").val($.toJSON(custom_keys))}else{$("#id_custom_keys").val("")}$("#id_payload").val($.toJSON(payload));submitButton.attr("disabled",!validator.validate());message.updateBytesRemaining()};var message=(function(){var previewItems=[],previewIndex,scrollBy,scrollLen;var Preview=function(opts){this.target=opts.target;this.onUpdate=opts.onUpdate;if(this.target.length>1){this.height=$($(this.target[0]).parents()[0]).height()}else{this.height=$(this.target.parents()[0]).height()}};Preview.prototype={update:function(str){for(var i=0;i<this.target.length;i++){$(this.target[i]).text(str)}},onUpdate:function(str){}};var MAX_PAYLOAD_BYTES=220-2;var MIN_PAYLOAD_BYTES=0;if(sendType==="message"){MAX_PAYLOAD_BYTES=1000}var lengthInUtf8Bytes=function(str){var m=encodeURIComponent(str).match(/%[89ABab]/g);return str.length+(m?m.length:0)};var calculateFinalBytes=function(obj){var payload_values=[];if($.type(obj)==="string"){payload_values.push(obj)}else{for(var key in obj){if(Object.prototype.toString.call(obj[key])=="[object Array]"){payload_values.push(obj[key].join(","))}else{if(Object.prototype.toString.call(obj[key])=="[object Object]"){payload_values.push(JSON.stringify(obj[key]))}else{payload_values.push(obj[key])}}}}var t1=lengthInUtf8Bytes(payload_values.join(""));if(sendType==="message"){var t2=270,t3=10;t1+=(t2+t3)}return t1};var calculateRemainingBytes=function(e){var payload_string=$("#id_payload").val(),raw_payload_object,payload_length;if(!payload_string.length){return MAX_PAYLOAD_BYTES-MIN_PAYLOAD_BYTES}raw_payload_object=JSON.parse(payload_string);var remaining_payload={};if(sendType==="message"){remaining_payload=raw_payload_object}else{remaining_payload.extra=raw_payload_object.extra;remaining_payload.alert=raw_payload_object.alert||"";if($.inArray("aps",raw_payload_object.platform)!=-1){raw_payload_object.badge=raw_payload_object.badge||1;raw_payload_object.sound=raw_payload_object.sound||"";if($("#id_content_available").is(":checked")){remaining_payload.ios='"ios":{"sound":'+raw_payload_object.sound+',"badge":'+raw_payload_object.badge+',"content_available":1}'}else{remaining_payload.ios='"ios":{"sound":'+raw_payload_object.sound+',"badge":'+raw_payload_object.badge+"}"}}if($.inArray("wp",raw_payload_object.platform)!=-1){remaining_payload.open_page='"open_page":'+(raw_payload_object.open_page||"")}}if($.inArray("aps",raw_payload_object.platform)!=-1&&sendType!=="message"){var ios_payload={};ios_payload.alert=raw_payload_object.alert||"";ios_payload.badge=raw_payload_object.badge||1;ios_payload.sound=raw_payload_object.sound||"";if(typeof(raw_payload_object.extra)!="undefined"){ios_payload.extra=raw_payload_object.extra}if($("#id_content_available").is(":checked")){ios_payload.content_available=1}payload_length=calculateFinalBytes(JSON.stringify(ios_payload))}else{payload_length=calculateFinalBytes(remaining_payload)}return MAX_PAYLOAD_BYTES-Math.max(payload_length,MIN_PAYLOAD_BYTES)};var updateBytesRemaining=function(e){var bytesRemaining=calculateRemainingBytes(e);var previewChars=$("#preview-chars");previewChars.removeClass("alert").removeClass("warning");if(bytesRemaining>10&&bytesRemaining<=50){previewChars.addClass("warning")}if(bytesRemaining<=10){previewChars.addClass("alert")}previewChars.text(Math.floor(bytesRemaining/3));return bytesRemaining};var updatePreviews=function(e){var target=$(e.target||e);var str=$("#id_silent_push").attr("checked")=="checked"?"":target.val();for(var i=0;i<previewItems.length;i++){previewItems[i].update(str)}generatePayload()};var scrollPreview=function(direction){return function(){var previewPosition=$("#preview-position span"),scrollBy=$("#previews .preview").width();var willScroll=direction===-1?(previewIndex>0):(previewIndex<scrollLen-1);if(willScroll){previewIndex+=direction;$("#preview-scroller").animate({scrollLeft:"+="+scrollBy*direction});previewPosition.removeClass("active");$(previewPosition.get(previewIndex)).addClass("active")}return false}};var init=function(){if($("#preview-ios5-lock").length){var iosUpdate=function(str){if(Math.ceil(this.target.height()/24)>=6){var val,len;while(Math.ceil(this.target.height()/24)>=6){val=this.target.html();len=val.length;this.target.html(val.substr(0,len-1))}this.target.html(val.substr(0,len-3)+"...")}};var ios5LockUpdate=function(str){if(Math.ceil(this.target.height()/10)>=10){var val,len;while(Math.ceil(this.target.height()/10)>=10){val=this.target.html();len=val.length;this.target.html(val.substr(0,len-1))}this.target.html(val.substr(0,len-4)+"...")}};var ios5NsUpdate=function(str){if(Math.ceil(this.target.height()/8)>=9){var val,len;while(Math.ceil(this.target.height()/8)>=9){val=this.target.html();len=val.length;this.target.html(val.substr(0,len-1))}this.target.html(val.substr(0,len-5)+"...")}};previewItems.push(new Preview({target:$("#preview-ios5-lock pre"),onUpdate:ios5LockUpdate}));previewItems.push(new Preview({target:$("#preview-ios5-ns pre"),onUpdate:ios5NsUpdate}));previewItems.push(new Preview({target:$("#preview-ios5-rolldown p"),onUpdate:iosUpdate}))}if($("#preview-android").length){previewItems.push(new Preview({target:[$("#preview-android p"),$("#preview-android span")],onUpdate:function(str){if(!this.hiddenDiv){this.hiddenDiv=$('<div id="android-task"></div>');this.scrollOffset=this.target[1].height()||16;$(document.body).append(this.hiddenDiv)}this.target[1].scrollTop(0);this.hiddenDiv.html(escape(str));clearTimeout(this.scrollTimeout);var self=this;this.scrollTimeout=setInterval(function(){if(self.target[1].scrollTop()>=self.hiddenDiv.height()-self.scrollOffset/2){self.target[1].hide().scrollTop(0).show()}else{self.target[1].animate({scrollTop:"+="+self.scrollOffset+"px"})}},3000)}}))}if($("#preview-win-helium").length){var winHeUpdate=function(str){};previewItems.push(new Preview({target:$("#preview-win-helium p"),onUpdate:winHeUpdate}))}if($("#preview-mpns").length){var mpnsUpdate=function(str){};previewItems.push(new Preview({target:$("#preview-mpns p"),onUpdate:mpnsUpdate}))}if($("#preview-wns").length){var wnsUpdate=function(str){};previewItems.push(new Preview({target:$("#preview-wns p"),onUpdate:wnsUpdate}))}previewIndex=0;scrollLen=previewItems.length;scrollBy=$("div.preview").width();$("#id_alert").bind("keyup",updatePreviews);setInterval(function(){updatePreviews($("#id_alert"))},300);$("#id_silent_push").bind("click",updatePreviews);$("#preview-scroller-prev").bind("click",scrollPreview(-1));$("#preview-scroller-next").bind("click",scrollPreview(1));$("div#optional-settings").on("change",updateBytesRemaining);$("div#optional-settings").on("change",generatePayload);updateBytesRemaining();updatePreviews.call($("#id_alert"),$("#id_alert"));for(var i=0;i<previewItems.length;i++){$("#preview-position").append("<span>&bull;</span>")}$($("#preview-position span").get(previewIndex)).addClass("active")};return{init:init,calculateRemainingBytes:calculateRemainingBytes,updateBytesRemaining:updateBytesRemaining}}());var recipients=(function(){var init=function(){tags.init();if($("#id_segmentid").length>0){segments.init()}$("#id_alias, #id_imei,#id_registrationid").bind("focus",function(e){generatePayload()});$("#id_alias, #id_imei,#id_registrationid").bind("keyup",function(e){generatePayload()});$("#id_segmentid").bind("change",function(e){generatePayload()});recipientTypes.alias.bind("click",function(e){$("#id_alias").val("");$("#id_imei").val("");segments.clean();$(this).closest(".bare-box").find(".revealed-field").hide();$("#alias-container").show();$("#id_alias").focus();delivery.switchDuration("close");generatePayload()});recipientTypes.tags.bind("click",function(e){$("#id_alias").val("");$("#id_imei").val("");segments.clean();$("#id_registrationid").val("");$(this).closest(".bare-box").find(".revealed-field").hide();if(is_richpush&&!is_richpush_pay&&!richpush_limit){$("#rich-push-notice-free").show()}else{$("#tag-search-box").show()}$("#tag_search").focus();delivery.switchDuration("open");generatePayload()});recipientTypes.broadcast.bind("click",function(e){$("#id_alias").val("");$("#id_imei").val("");$("#id_registrationid").val("");segments.clean();$(this).closest(".bare-box").find(".revealed-field").hide();if(is_richpush&&!is_richpush_pay&&!richpush_limit){$("#rich-push-notice-free").show()}else{if((is_richpush&&richpush_limit)||is_richpush_pay){$("#broadcast-notice").show()}}delivery.switchDuration("open");generatePayload()});recipientTypes.imei.bind("click",function(e){$("#id_alias").val("");$("#id_imei").val("");segments.clean();$(this).closest(".bare-box").find(".revealed-field").hide();$("#imei-container").show();$("#id_imei").focus();delivery.switchDuration("close");generatePayload()});recipientTypes.registrationid.bind("click",function(e){$("#id_alias").val("");$("#id_registrationid").val("");segments.clean();$(this).closest(".bare-box").find(".revealed-field").hide();$("#registrationid-container").show();$("#id_registrationid").focus();delivery.switchDuration("close");generatePayload()});recipientTypes.segmentid.bind("click",function(e){segments.clean();$(this).closest(".bare-box").find(".revealed-field").hide();$("#segmentid-container").show();$("#id_segmentid").tagsinput("focus");delivery.switchDuration("open");generatePayload()})};return{init:init}}());var segments=(function(){var segmentInput=$("#id_segmentid");var init=function(opts){segmentInput.tagsinput({itemValue:"segmentId",itemText:"segmentName"});segmentInput.tagsinput("input").typeahead({valueKey:"segmentName",prefetch:[basePath+feature,appKey,mod,"segments/ajax"].join("/"),template:"<p>{{segmentName}}</p>",engine:Hogan,limit:10}).bind("typeahead:selected",$.proxy(function(obj,datum){this.tagsinput("add",datum);this.tagsinput("input").typeahead("setQuery","")},segmentInput))};var selectedSegments=function(){return segmentInput.val()};var clean=function(){segmentInput.tagsinput("removeAll")};return{init:init,selectedSegments:selectedSegments,clean:clean}}());var tags=(function(){var searchTimeout,selectedTags={},results=[],currentResult=-1;var list,search,searchShadow,device_tags,loader,selectedDisplay,defaultSearchValue;var listListener=function(e){if(search.is(":focus")){switch(e.keyCode){case 9:if(searchShadow.val()>""&&searchShadow.val()!==search.val()){search.val(searchShadow.val());searchShadow.val("")}if(list.is(":visible")){e.preventDefault()}break;case 13:if(!validateTag(search)){return}list.hide();var html_tag=$('<a class="selected-tag"></a>').text(search.val());var selected;if(results.length>0){selected=searchShadow.val()||$("#result-"+currentResult).text()}else{selected=search.val()}if(!selectedTags[selected]){selectedDisplay.append(html_tag)}selectedTags[search.val()]=true;search.val("");generatePayload();e.preventDefault();break;case 27:list.hide();$(e.target).val(defaultSearchValue);break;case 38:currentResult--;if(currentResult<0){currentResult=results.length-1}search.val($("#result-"+currentResult).text());e.preventDefault();break;case 40:currentResult++;if(currentResult>results.length-1){currentResult=0}search.val($("#result-"+currentResult).text());e.preventDefault();break}list.find("li").removeClass("active");$("#result-"+currentResult).addClass("active");searchShadow.val("")}};var validateTag=function(ctl){var value=ctl.val();var s=/^[a-zA-Z0-9_\u4e00-\u9fa5]+$/.test(value)&&value.length<=40;ctl[s?"removeClass":"addClass"]("error");return s};var tagSearchCore=function(tag_value){results=[];$.ajax({url:[basePath+feature,appKey,mod,"tags/?tag="+tag_value].join("/"),dataType:"json",type:"get",success:function(data){list.show().find("li").remove();results=data;currentResult=-1;if(data&&data.length>0){data.length>=10?list.addClass("overflow"):list.removeClass("overflow");searchShadow.val(data[0]);var out=[];for(var i=0,tag;tag=data[i];i++){out.push($('<li id="result-'+i+'"></li>').text(tag))}out.forEach(function(x){list.append(x)})}else{list.hide()}}});list.show().find("li").remove();currentResult=-1};var tagSearch=function(e){loader.show();validateTag(search);var value=$(e.target).val();if(value>""&&value!=defaultSearchValue){tagSearchCore(value)}else{list.hide()}};var performTagSearch=function(e){if(e.keyCode!==13&&e.keyCode!==38&&e.keyCode!==40&&e.keyCode!==27){clearTimeout(searchTimeout);searchTimeout=setTimeout(function(){tagSearch(e)},500)}else{if(e.keyCode===13){clearTimeout(searchTimeout);results=[];loader.hide()}e.preventDefault()}};var init=function(opts){list=$("#tag-list");search=$("#tag_search");searchShadow=$("#tag_search_shadow");device_tags=$("#id_tags");loader=$("#loader");selectedDisplay=$("#selected-tags");defaultSearchValue=search.val();$(window).bind("keydown",listListener);search.bind("keyup",performTagSearch);search.bind("initSelectedTags",function(event,_tags){for(var i in _tags){selectedTags[_tags[i]]=true}});search.bind("focus",function(e){var target=$(e.target);if(target.val()===defaultSearchValue){target.val("")}recipientTypes.tags.attr("checked","checked");generatePayload()});search.bind("blur",function(e){var target=$(e.target);if(!target.val()){search.val(defaultSearchValue);searchShadow.val("")}});search.bind("click",function(e){var value=$(e.target).val();if(value===""){clearTimeout(searchTimeout);searchTimeout=setTimeout(function(){tagSearchCore(value)},500)}});selectedDisplay.bind("click",function(e){var target=$(e.target);if(target.hasClass("selected-tag")){delete selectedTags[target.text()];target.remove();var revalue=[];$.each(selectedTags,function(k,v){if(v){revalue.push(k)}});device_tags.val(revalue.join(","))}generatePayload()});list.bind("mouseover",function(e){var target=$(e.target);if(target.get(0).nodeName==="LI"){list.find("li").removeClass("active");target.addClass("active");if(currentResult===-1){currentResult=0}for(var i=0,res;res=results[i];i++){if(res===target.text()){currentResult=i;break}}}});list.bind("mouseout",function(e){list.find("li").removeClass("active");currentResult=-1});list.bind("click",function(e){var target=$(e.target);if(target.get(0).nodeName==="LI"){search.val(target.text());var selected=search.val();if(!selectedTags[selected]){selectedDisplay.append($('<a class="selected-tag"></a>').text(search.val()))}list.hide();search.val(defaultSearchValue);searchShadow.val("");selectedTags[selected]=true;search.focus();generatePayload()}});if(device_tags.val()>""){var t=device_tags.val().split(",");$.each(t,function(i,item){selectedTags[item]=item;selectedDisplay.append($('<a class="selected-tag"></a>').text(item))});$("#id_alias").val("");$(this).closest(".bare-box").find(".revealed-field").hide();$("#tag-search-box").show();$("#tag_search").focus()}};return{init:init,selectedTags:selectedTags}}());var delivery=(function(){var datePicker;var setToNow=function(){var d=new Date();var dateString=$.map([d.getFullYear(),d.getMonth()+1,d.getDate()],padNum).join("-");var timeString=$.map([d.getHours(),d.getMinutes(),d.getSeconds()],padNum).join(":");var tzOffset=d.toString().indexOf("GMT")!==-1?d.toString().replace(/^.*?GMT(.*?)\s.*?$/,"$1"):"-0800";deliveryFields.date.val(dateString);deliveryFields.time.val(timeString);deliveryFields.timezone.val(tz_offset_mapping[tzOffset]);datePicker.setTo(d);generatePayload()};var parseDate=function(){var time=deliveryFields.time.val();if(!time.match(/:/)){time=time+":00"}return new Date(Date.parse(deliveryFields.date.val().replace("-","/").replace("-","/")+" "+time))};var switchDuration=function(data){if(data=="open"){$("#id_duration_lable").show()}else{$("#id_duration_lable").hide();if(deliveryTypes.duration.is(":checked")){deliveryTypes.now.attr("checked","checked")}}};var validDurationTime=function(){if(!deliveryFields.duration_time.val()){return false}if(isNaN(deliveryFields.duration_time.val())||deliveryFields.duration_time.val()<0||deliveryFields.duration_time.val()>1440){deliveryFields.duration_time.addClass("error");return false}deliveryFields.duration_time.removeClass("error");return true};var validDate=function(date){if(isNaN(date.getFullYear())){return false}var now=new Date();if(delivery.parseDate()<now.getTime()){return false}return true};var init=function(){datePicker=new DatePicker({bindTo:deliveryFields.date});deliveryTypes.now.bind("click",setToNow);deliveryTypes.duration.bind("click",function(e){$("#later-duration").show();deliveryFields.duration_time.focus()});deliveryTypes.scheduled.bind("click",function(e){$("#later-delivery").show();deliveryFields.date.focus()});deliveryFields.date.bind("focus",function(){deliveryTypes.scheduled.attr("checked","checked");generatePayload()});deliveryFields.date.bind("keyup",function(){generatePayload()});deliveryFields.time.bind("focus",function(){deliveryTypes.scheduled.attr("checked","checked");generatePayload()});deliveryFields.time.bind("keyup",function(){generatePayload()});deliveryFields.timezone.bind("change",function(){generatePayload()});deliveryFields.duration_time.bind("focus",function(){deliveryTypes.duration.attr("checked","checked");generatePayload()});deliveryFields.duration_time.bind("keyup",function(){generatePayload()});setToNow()};return{init:init,parseDate:parseDate,validDate:validDate,validDurationTime:validDurationTime,switchDuration:switchDuration}}());var advanced=(function(){var toggleOptionalSettings=function(type,enabled){if(enabled){$("li."+type).removeClass("disabled");$("li."+type+" input, li."+type+" select").removeAttr("disabled")}else{$("li."+type).addClass("disabled");$("li."+type+" input, li."+type+" select").attr("disabled","disabled")}};var init=function(){$("#optional-settings h4").bind("click",function(e){var t=$("#optional-settings div.bare-box");if(!t.is(":visible")){$(this).addClass("open");t.slideDown("fast")}else{$(this).removeClass("open");t.slideUp("fast")}$("a.help-btn.open").click();return false});$.each(deviceTypes,function(i,item){var scope="#device-specific li."+item;$(scope+" input[type=text]").bind("keyup",function(e){if($(e.target).val()>""){$(".class_"+item).attr("checked","checked")}generatePayload()});$(".class_"+item).bind("click",function(e){toggleOptionalSettings(item,$(e.target).is(":checked"));generatePayload()});toggleOptionalSettings(item,$(".class_"+item).is(":checked"));return true});var support_types=["android","aps","wp"];$.each(support_types,function(i,type){toggleOptionalSettings(type,false)});$.each(deviceTypes,function(i){if(pushType==="richpush"&&deviceTypes[i]==="aps"){return}if(pushType==="richpush"&&deviceTypes[i]==="wp"){return}toggleOptionalSettings(deviceTypes[i],true)});if(deviceTypes.length==1){$("#device-specific li").addClass("disabled").find("input").attr("disabled","disabled")}var time_to_live=$("#id_time_to_live");$("#id_time_to_live_handler").bind("change",function(e){var self=$(this);if($(this).val()==-1){time_to_live.val("");$("#id_time_to_live_custom").animate({left:"295px",opacity:1},100,function(){time_to_live.focus()}).show()}else{$("#id_time_to_live_custom").fadeOut("fast",function(){time_to_live.val(self.val());$(this).css("left",0)})}});generatePayload()};return{init:init}}());var richmedia=(function(){var init=function(){richMediaType.rich_media_net.bind("click",function(e){$("#id_rich_media_type_1_file,#id_rich_media_type_1_file_name").val("");$("#id_rich_media_type_1_file").next("span[class=error]").empty();generatePayload()});richMediaType.rich_media_local.bind("click",function(e){$("#id_rich_media_type_0_file").val("");$("#id_rich_media_type_0_file").next("span[class=error]").empty();generatePayload()});richMediaType.rich_media_net_file.bind("click",function(e){richMediaType.rich_media_net.trigger("click")});richMediaType.rich_media_local_file.bind("click",function(e){richMediaType.rich_media_local.trigger("click")})};return{init:init}}());var validator=(function(){var notBlank=function(item){return !!item.val()};var checkByteLength=function(){return message.calculateRemainingBytes()>=0};var checkAlert=function(){if(checkPushType()){return notBlank($("#id_alert"))}return true};var checkSysFile=function(){if(checkPushType()){var syn_file=$("#id_syn_file_code").val();if(syn_file!=null&&syn_file=="true"){return true}else{return false}}return true};var checkTypeSelected=function(){var typesToFields={broadcast:"id_broadcast",tags:"id_tags",alias:"id_alias",imei:"id_imei",registrationid:"id_registrationid",segmentid:"id_segmentid"};var selected=false;$("#recipient-choices input[type=radio]").each(function(i,item){if($(item).is(":checked")){if(typesToFields[$(item).val()]){if(notBlank($("#"+typesToFields[$(item).val()]))){if($(item).val()==="imei"){if($("#id_imei").val()){selected=true;$("#id_alias,#id_tags,#id_broadcast").val("")}else{selected=false}}else{selected=true;if($(item).val()==="registrationid"){$("#id_alias","#id_tags").val("")}if($(item).val()==="tags"){$("#id_imei, #id_alias, #id_registrationid, #id_segmentid").val("")}if($(item).val()==="alias"){$("#id_imei, #id_tags, #id_registrationid, #id_segmentid").val("")}if($(item).val()==="broadcast"){$("#id_imei, #id_tags, #id_alias, #id_registrationid, #id_segmentid").val("")}if($(item).val()==="segmentid"){$("#id_imei, #id_tags, #id_alias, #id_registrationid").val("")}}}else{selected=false}}else{selected=true}if((is_richpush&&richpush_limit)||is_richpush_pay){if($(this).attr("id")=="id_recipient_type_0"){selected=true}}else{if(!is_richpush){if($(this).attr("id")=="id_recipient_type_0"){selected=true}}}}});return selected};var checkRichMediaSelected=function(){if($("#rich_media_choices").length<=0){return true}return notBlank($("#id_rich_media_uri"))};var checkScheduledDate=function(){if(!deliveryTypes.scheduled.is(":checked")){return true}return delivery.validDate(delivery.parseDate())};var checkDurationTime=function(){if(!deliveryTypes.duration.is(":checked")){return true}return delivery.validDurationTime()};var checkOptions=function(){var selected=false;$("#device-specific input").each(function(i,item){if($(item).is(":checked")){selected=true;return}});return selected};var checkTtl=function(){var time_to_live=$("#id_time_to_live");if(time_to_live.length>0&&time_to_live.val()!=""){if(isNaN(time_to_live.val())){time_to_live.addClass("error");return false}}time_to_live.removeClass("error");return true};var checkTitle=function(){var title=$("#id_alert_title");var isSuccess=true;if(checkPushType()){isSuccess=notBlank(title)}if(title.length>0&&title.val()!=""){if(title.val().length>60){title.addClass("error");isSuccess=false}}if(isSuccess){title.removeClass("error")}return isSuccess};var checkNotificationBar=function(){var notification_bar=$("#id_android_notification_bar_id");if(notification_bar.length>0&&notification_bar.val()!=""){if(!/^[1-9]\d*$/.test(notification_bar.val())||parseInt(notification_bar.val())>1000){notification_bar.addClass("error");return false}}notification_bar.removeClass("error");return true};var checkBadge=function(){var badge=$("#id_badge");if($("#id_silent_push").attr("checked")=="checked"){return true}if(badge.length>0&&!$.isNumeric(badge.val())){badge.addClass("error");return false}badge.removeClass("error");return true};var checkExtras=function(){var extras_keys=$("[name=custom_key]");extras_keys.removeClass("error");var hash={};for(var i in $(extras_keys).toArray()){if(hash[$(extras_keys[i]).val()]){$(extras_keys[i]).addClass("error");$(extras_keys[hash[$(extras_keys[i]).val()]]).addClass("error");return false}hash[$(extras_keys[i]).val()]=i}extras_keys.removeClass("error");return true};var validations=[checkAlert,checkByteLength,checkTypeSelected,checkScheduledDate,checkDurationTime,checkOptions,checkTtl,checkNotificationBar,checkBadge,checkExtras,checkRichMediaSelected,checkSysFile];var validate=function(e){var valid=true;$.each(validations,function(i,item){if(!item.call(this)){valid=false}});if(e&&!valid){e.preventDefault()}return valid};var init=function(){$("#push-form").bind("submit",function(e){var valid=validate(),msg_type="";return valid})};return{init:init,validate:validate}}());var init=function(opts){deviceTypes=opts.deviceTypes;message.init();recipients.init();delivery.init();advanced.init();richmedia.init();validator.init();if($("#id_custom_keys").val()){var t=$("#optional-settings div.bare-box");$(this).addClass("open");t.slideDown("fast")}};return{init:init,generatePayload:generatePayload,message:message}}());return pushManager});